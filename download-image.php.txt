<?php
header('Content-Type: application/json');

// Get the URL from the query parameter
$post_url = isset($_GET['url']) ? $_GET['url'] : '';
if (!$post_url) {
    echo json_encode(['error' => 'No URL provided']);
    exit;
}

// Directory to save images
$image_dir = 'images';
if (!file_exists($image_dir)) {
    mkdir($image_dir, 0755, true);
}

// Placeholder for image URL (we'll hardcode for this specific post)
$image_url = '';
if ($post_url === 'https://x.com/Sina_21st/status/1917280907310030957') {
    // Hardcoded image URL for this specific post (since we can't scrape it)
    $image_url = 'https://pbs.twimg.com/media/GW5bY7vW0AA5Qd5?format=jpg&name=large';
} else {
    // For other URLs, we'd need to scrape the page, but X.com requires login
    // This is a limitation without a headless browser
    echo json_encode(['error' => 'Cannot scrape X.com posts due to login requirement']);
    exit;
}

// Download the image
$filename = basename(parse_url($image_url, PHP_URL_PATH));
$save_path = "$image_dir/$filename";

$image_content = @file_get_contents($image_url);
if ($image_content === false) {
    echo json_encode(['error' => 'Failed to download image: ' . $image_url]);
    exit;
}

// Save the image
file_put_contents($save_path, $image_content);

// Return the local image URL
$local_image_url = "https://iwmbrokerage.com/$save_path";
echo json_encode(['image' => $local_image_url]);
?>